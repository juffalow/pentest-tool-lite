import Test, { TestParameters, Result } from '../Test';
import request from '../request';
import logger from '../logger';
import { getHeading, parseHtml } from '../functions';

class Heading extends Test {
  public name = 'Heading';

  public async test({ url }: TestParameters): Promise<Result> {
    logger.info(`Starting ${this.constructor.name} test...`);

    const response = await request.get(url);
    const html = await parseHtml(response);
    const heading = getHeading(html);
    const subTests = this.checkHeading(heading);

    return {
      status: this.getStatus(subTests.map(test => test.status)),
      title: this.constructor.name,
      description: '',
      results: subTests,
    };
  }

  private checkHeading(title: string | string[]): Array<Result> {
    const results = [];

    if (typeof title === 'undefined') {
      return [{
        status: 'ERROR',
        title: 'H1 tag',
        description: 'HTML should contain H1 tag.',
      }];
    }

    results.push({
      status: typeof title !== undefined && title.length > 0 ? 'SUCCESS' : 'WARNING',
      title: 'H1 tag',
    });

    results.push({
      status: Array.isArray(title) ? 'ERROR' : 'SUCCESS',
      title: 'Duplicate H1 tag',
      description: `HTML should contain just one H1 tag.`,
    });

    results.push({
      status: title.length <= 60 ? 'SUCCESS' : 'WARNING',
      title: 'H1 length',
      description: `H1 length should be under 60 characters and it is ${title.length}.`,
    });

    return results;
  }
}

export default Heading;
