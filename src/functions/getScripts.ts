import { URL } from 'url';
import getObject from './getObject';

/**
 * Searches for script tags in response which has "src".
 * The source of the script can has several forms:
 *   * https://example/js/javascript.js
 *   * /js/javascript.js
 *   * ./js/javascript.js
 *
 * It returns an array of links to JavaScript files. Every URL
 * is full URL.
 */
const getScripts = (result: any): string[] => {
  const origin = (new URL(result.url)).origin;

  return getObject(result.html, 'type', 'script')
    .filter((script: any) => {
      return Object.prototype.hasOwnProperty.call(script, 'attribs') && Object.prototype.hasOwnProperty.call(script.attribs, 'src');
    }).map((script: any) => {
      if (script.attribs.src.startsWith('./')) {
        if (result.url.endsWith('/')) {
          return result.url + script.attribs.src.substring(2);
        }
        return result.url + script.attribs.src.substring(1);
      }
      if (script.attribs.src.startsWith('/')) {
        return origin + script.attribs.src;
      }
      if (!script.attribs.src.startsWith('http')) {
        return origin + '/' + script.attribs.src;
      }
      return script.attribs.src;
    });
};

export default getScripts;
