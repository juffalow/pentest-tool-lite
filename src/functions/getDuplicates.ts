import { Parser } from 'htmlparser2';

export default function(result: any): Promise<any> {
  return new Promise((resolve) => {
    let elementsWithId = [];
    const parser = new Parser({
      onend: () => {
        const ids = elementsWithId.map((element) => element.attribs.id);
        const duplicates = new Set(ids.filter((id, index, array) => array.indexOf(id) < index));
        resolve(elementsWithId.filter((element) => duplicates.has(element.attribs.id)));
      },
      onopentag: (name, attribs) => {
        if (Object.prototype.hasOwnProperty.call(attribs, 'id')) {
          elementsWithId = [...elementsWithId, { name, attribs }];
        }
      },
    }, {lowerCaseAttributeNames: true});
    parser.write(result.body);
    parser.end();
  });
}
