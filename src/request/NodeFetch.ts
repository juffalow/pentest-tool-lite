import fetch from 'node-fetch';
import Request, { Options, Response } from './Request';
import config from '../config';

const getHeaders = (headers) => {
  const keyValues = {};

  Object.keys(headers).forEach((header) => {
    if (headers[header].length === 1 && header !== 'set-cookie') {
      keyValues[header] = headers[header][0];
    } else {
      keyValues[header] = headers[header];
    }
  });

  return keyValues;
};

export default class NodeFetch implements Request {
  public async get(url: string, options?: Options): Promise<Response> {
    const defaultOptions = config.request.options as any;
    const response = await fetch(url, { ...defaultOptions, ...options });
    const body = await response.text();
    const statusCode = response.status;
    const statusText = response.statusText;
    const headers = getHeaders(response.headers.raw());

    return {
      response,
      statusCode,
      statusText,
      headers,
      body,
      url,
    };
  }
}
