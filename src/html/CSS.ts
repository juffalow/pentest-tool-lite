import CSSO from 'csso';
import Test, { TestParameters, Result } from '../Test';
import request from '../request';
import logger from '../logger';
import { getStylesheets, parseHtml } from '../functions';

class CSS extends Test {

  public async test({ url }: TestParameters): Promise<Result> {
    logger.info(`Starting ${this.constructor.name} test...`);
    const response = await request.get(url);
    const html = await parseHtml(response);
    const stylesheets = getStylesheets(html);
    const subTests = await this.check(stylesheets);

    return {
      status: subTests.some(check => check.status === 'WARNING') ? 'WARNING' : 'SUCCESS',
      title: this.constructor.name,
      description: '',
      results: subTests,
    };
  }

  private async check(stylesheets: Array<string>): Promise<Array<Result>> {
    const results = [];

    for (const stylesheet of stylesheets) {
      const filename = stylesheet.substr(stylesheet.lastIndexOf('/') + 1);
      logger.verbose(`Checking ${filename}...`);

      const result = await request.get(stylesheet);

      const isFileAvailabe = {
        status: this.isFileAvailable(result) ? 'SUCCESS' : 'ERROR',
        title: 'Available',
        description: '',
      };
      const isCached = {
        status: this.isCached(result) ? 'SUCCESS' : 'ERROR',
        title: 'Cached',
        description: '',
      };
      const hasXContentTypeOptionsHeader = {
        status: this.hasXContentTypeOptionsHeader(result) ? 'SUCCESS' : 'WARNING',
        title: 'X-Content-Type-Options',
        description: '',
      }
      const isMinified = {
        status: this.isMinified(result) ? 'SUCCESS' : 'WARNING',
        title: 'Minified',
        description: '',
      }

      results.push({
        status: 'SUCCESS',
        title: filename,
        description: '',
        results: [
          isFileAvailabe,
          isCached,
          hasXContentTypeOptionsHeader,
          isMinified,
        ],
      });
    }

    return results;
  }

  protected isFileAvailable(result: any): boolean {
    if (result.response.statusCode === 404 || result.response.statusCode === 500) {
      return false;
    }
    return true;
  }

  protected isCached(result: any): boolean {
    return Object.prototype.hasOwnProperty.call(result.response.headers, 'cache-control');
  }

  protected hasXContentTypeOptionsHeader(result: any): boolean {
    return Object.prototype.hasOwnProperty.call(result.response.headers, 'x-content-type-options');
  }

  protected isMinified(result: any): boolean {
    const r = CSSO.minify(result.body, {restructure: false}).css;
    return r.length === result.body.length;
  }
}

export default CSS;
