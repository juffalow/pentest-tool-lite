// @flow
import Result, { TYPE_OK, TYPE_INCORRECT, TYPE_ERROR } from '../pentest/Result';
import csso from 'csso';

export default class CSS {
  request: Object;
  parseHtml: Function;
  getResources: Function;
  logger: Object;
  
  /**
   * 
   * @param {Object} request
   * @param {Function} parseHtml
   * @param {Function} getResources
   * @param {Object} logger
   */
  constructor(request: Object, parseHtml: Function, getResources: Function, logger: Object) {
    this.request = request;
    this.parseHtml = parseHtml;
    this.getResources = getResources;
    this.logger = logger;
  }

  filterCSSFiles(resources) {
    const regx = new RegExp('.*\\/([a-z0-9.-])+(\\.css)((\\?)?(.*))', 'i');
    return resources.filter((resource) => {
      return regx.test(resource);
    });
  }

  isFileAvailable(result: Object): boolean {
    if (result.response.statusCode === 404 || result.response.statusCode === 500) {
      return false;
    }
    return true;
  }

  isCached(result: Object): boolean {
    return result.response.headers.hasOwnProperty('cache-control');
  }

  hasXContentTypeOptionsHeader(result: Object): boolean {
    return result.response.headers.hasOwnProperty('x-content-type-options');
  }

  isMinified(result: Object): boolean {
    const r = csso.minify(result.body, {restructure: false}).css;

    return r !== result.body;
  }

  async checkCSSFile(url: string): Object {
    const result = await this.request.get(url);
    let tests = [];

    if (!this.isFileAvailable(result)) {
      tests = [...tests, new Result('available', TYPE_ERROR)];
      return new Result(url, TYPE_ERROR, tests);
    }

    tests = [...tests, new Result('available', TYPE_OK)];
    tests = [...tests, new Result('cache', this.isCached(result) ? TYPE_OK : TYPE_INCORRECT)];
    tests = [...tests, new Result('x-content-type-options', this.hasXContentTypeOptionsHeader(result) ? TYPE_OK : TYPE_INCORRECT)];
    tests = [...tests, new Result('minify', this.isMinified(result) ? TYPE_OK : TYPE_INCORRECT)];

    return new Result(url, tests.filter(test => test.resultType !== TYPE_OK).length === 0 ? TYPE_OK : TYPE_INCORRECT, tests);
  }

  /**
   * 
   * @param {string} url
   * @returns {Object}
   */
  async execute(url: string): Object {
    this.logger.verbose('Executing CSS test...');

    const result = await this.request.get(url);
    const parsedHtml = await this.parseHtml(result);
    const resources = await this.getResources(parsedHtml);
    const files = this.filterCSSFiles(resources);

    const results = await Promise.all(files.map(async (file) => await this.checkCSSFile(file)));

    return new Result(url, results.filter(result => result.resultType !== TYPE_OK).length === 0 ? TYPE_OK : TYPE_INCORRECT, results);
  }
}