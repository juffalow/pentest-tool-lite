import Test, { TestParameters, Result } from '../Test';
import request from '../request';
import logger from '../logger';

/**
 *
 * @see https://en.wikipedia.org/wiki/HTTP/2
 * @see https://en.wikipedia.org/wiki/HTTP/3
 */
class HTTPVersion extends Test {
  public name = 'HTTP Version';

  public async test({ url }: TestParameters): Promise<Result> {
    logger.info('Starting HTTPVersion test...');
    const response = await request.get(url);

    if (Object.prototype.hasOwnProperty.call(response.headers, 'upgrade')) {
      const attributes = response.headers['upgrade'].replace(' ', '').split(',');
      const h2 = attributes.indexOf('h2') > -1;

      if(h2) {
        return {
          status: 'WARNING',
          title: 'HTTP/2',
          description: 'The current HTTP version is 2. Can be upgraded to 3.',
        };
      }
    }

    if (Object.prototype.hasOwnProperty.call(response.headers, 'alt-svc')) {
      const attributes = response.headers['alt-svc'].replace(' ', '').split(',');
      const h3 = attributes.find(a => a.includes('h3'));

      if(typeof h3 !== 'undefined') {
        if(h3) {
          return {
            status: 'SUCCESS',
            title: 'HTTP/3',
            description: 'The value of HTTP/3 header is present.',
          };
        }
      }
    }

    return {
      status: 'ERROR',
      title: 'HTTP/1',
      description: 'The current HTTP version is 1. Should be upgraded at least to 2!',
    };
  }
}

export default HTTPVersion;
