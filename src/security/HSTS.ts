import Test from '../Test';

/**
 * HTTP Strict Transport Security
 * 
 * Recommended value is at least one year (31536000).
 * 
 * @see https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security
 * @see https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security
 */
class HSTS extends Test {
  protected request: RequestInterface;

  protected logger: LoggerInterface;

  protected minValue: number = 31536000;

  constructor(request: RequestInterface, logger: LoggerInterface) {
    super();
    this.request = request;
    this.logger = logger;
  }

  async run(url: string): Promise<ResultInterface> {
    this.logger.info('Starting HSTS test...');
    const result = await this.request.get(url);

    if (!result.response.headers.hasOwnProperty('strict-transport-security')) {
      return this.getResult('HSTS', 'ERROR');
    } else {
      const attributes = result.response.headers['strict-transport-security'].replace(' ', '').split(';');
      const maxAge = attributes.filter((attribute) => { return attribute.startsWith('max-age'); }).shift().replace('max-age=', '');
  
      if (parseInt(maxAge) < this.minValue) {
        return this.getResult('HSTS', 'WARNING');
      }
    }
    return this.getResult('HSTS', 'SUCCESSFUL');
  }
}

export default HSTS;
