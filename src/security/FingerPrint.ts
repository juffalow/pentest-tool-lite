import Test, { TestParameters, Result } from '../Test';
import request from '../request';
import logger from '../logger';

/**
 *
 * @see https://www.owasp.org/index.php/Fingerprint_Web_Server_(OTG-INFO-002)
 * @see https://www.owasp.org/index.php/Fingerprint_Web_Application_Framework_(OTG-INFO-008)
 */
class FingerPrint extends Test {
  protected knownHeaders: string[] = [ 'x-powered-by', 'x-generator', 'server' ];

  public async test({ url }: TestParameters): Promise<Result> {
    logger.info('Starting FingerPrint test...');
    const response = await request.get(url);

    if (this.hasFingerPrintHeader(response.headers)) {
      return {
        status: 'ERROR',
        title: 'FingerPrint',
        description: 'Response headers includes at least one of finger print headers!',
      };
    }

    return {
      status: 'SUCCESS',
      title: 'FingerPrint',
      description: `Response headers don't inlcude any of finger print headers.`,
    };
  }

  private hasFingerPrintHeader(headers: unknown): boolean {
    return Object.keys(headers).filter((header) => this.knownHeaders.includes(header)).length > 0;
  }
}

export default FingerPrint;
